import{b as g}from"./chunk-STTCBUMV.js";import{a as P}from"./chunk-VV2Q5YND.js";import{Ba as s,Da as E,Ga as b,ea as c,i as n,ia as v,ja as C}from"./chunk-TR6HYK2P.js";var w=class a{consoleOutput;attach(e){this.consoleOutput=e.nativeElement}addConsoleLine(e){if(!this.consoleOutput||e.startsWith("#"))return;let r=new Date().toLocaleTimeString("en-US",{hour12:!1}),i=document.createElement("div");i.textContent=`[${r}] ${e}`,this.consoleOutput.insertBefore(i,this.consoleOutput.firstChild)}static \u0275fac=function(t){return new(t||a)};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};var u=class a{constructor(e,t){this.consoleService=e;this.supabaseService=t}hardwareIP=s("HARDWARE-IP");evtKey=s("");evtConfig=s("");isConnected=s(!1);hasAvailableDevice=s(!1);measuringLatency=s(!1);latencyStats=s({latency:0,jitter:0,min:0,max:0,median:0,samples:0});EvtJoystick2=s("");EvtLight=s("");EvtButton=s("");reading=!1;stoped_after_reading=!1;lineQueue=[];waitingResolvers=[];MAX_QUEUE_SIZE=100;sleep=e=>new Promise(t=>setTimeout(t,e));requestAndConnectDevice(){return n(this,null,function*(){yield this.requestDevice(),yield this.connect()})}flushQueues(){this.lineQueue=[],this.waitingResolvers=[]}processLine(e){if(this.supabaseService.userTier()==="Developer"&&console.log(e),!!P.INPUT_COMMANDS.some(t=>e.startsWith(t))){if(/^EVT=(JOY|LUX|BTN)/.test(e)){this.handleUnitsEvents(e);return}if(/^EVT=(KEY|SET)/.test(e)){this.handleEvents(e);return}if(this.consoleService.addConsoleLine(e),e.startsWith("RESP=WIFI_CONNECTED")){let t=e.split("IP=")[1].split(";")[0];this.hardwareIP.set(t)}this.waitingResolvers.length>0?this.waitingResolvers.shift()(e):(this.lineQueue.length>=this.MAX_QUEUE_SIZE&&this.lineQueue.shift(),this.lineQueue.push(e))}}handleUnitsEvents(e){if(e.startsWith("EVT=JOY")){let t=e.slice(7,-1).trim();this.EvtJoystick2.set(t)}if(e.startsWith("EVT=LUX")){let t=e.slice(7,-1).trim();this.EvtLight.set(t)}if(e.startsWith("EVT=BTN")){let t=e.slice(7,-1).trim();this.EvtButton.set(t)}}handleEvents(e){let t=e.match(/^EVT=KEY (.{1});?$/);t&&this.evtKey.set(t[1]);let r=e.match(/^EVT=SET (.+?);?$/);r&&this.evtConfig.set(r[1])}measureLatency(e=0){return n(this,null,function*(){this.measuringLatency.set(!0),this.latencyStats.set({latency:0,jitter:0,min:0,max:0,median:0,samples:0});let t=!0;e===0&&(t=!1,e=this.samplesToTest),yield this.writeLine('CMD=@BIP;CMD=@TITLE "Latency Test";'),yield this.writeLine("CMD=@LATENCY;"),yield this.sleep(300),yield this.stopListening();let r=0;for(;r<100&&!(yield this.readLineFromSource()).trim().endsWith("#DUMMY@");)r++;for(yield this.writeLineToSource("@"),r=0;r<100&&(yield this.readLineFromSource()).trim()!=="@";)r++;let i=[],d="";for(;!i.length||i.length<e;){let o=String.fromCharCode(97+Math.floor(Math.random()*26)),l=performance.now();yield this.writeLineToSource(o),d=yield this.readLineFromSource();let p=performance.now();d===o&&i.push(p-l),i.length%1e3===0&&console.log(`Processed ${i.length} samples`)}if(yield this.sleep(100),yield this.writeLineToSource("EXIT"),t){let o=JSON.stringify(i),l=new Blob([o],{type:"application/json"}),p=URL.createObjectURL(l),D=document.createElement("a");D.href=p,D.download=`${this.mode}_latencies_${i.length}samples_${new Date().toISOString().slice(0,19)}.json`,D.click(),URL.revokeObjectURL(p)}let h=i.reduce((o,l)=>o+l,0)/i.length,m=i.reduce((o,l)=>o+Math.pow(l-h,2),0)/i.length,T=Math.sqrt(m),f=[...i].sort((o,l)=>o-l),I=f.length;this.latencyStats.set({latency:h,jitter:T,min:Math.min(...i),max:Math.max(...i),median:f.length%2===0?(f[I/2-1]+f[I/2])/2:f[Math.floor(I/2)],samples:i.length}),this.measuringLatency.set(!1),yield this.writeLine("CMD=@BIP;CMD=@BRAND;"),yield this.startListening()})}startListening(){return n(this,null,function*(){this.flushQueues(),this.reading=!0,this.stoped_after_reading=!1;let e="";for(;this.reading;)try{let[t,r]=yield this.readChunk();r&&(this.stoped_after_reading=!0),e+=t;let i=e.split(`
`);e=i.pop()||"";for(let d of i)this.processLine(d.trim())}catch(t){console.error("Error reading from USB:",t),this.reading=!1,this.stoped_after_reading=!0}})}readLine(){return this.lineQueue.length>0?Promise.resolve(this.lineQueue.shift()):this.waitingResolvers.length>=this.MAX_QUEUE_SIZE?Promise.reject(new Error("Too many pending readLine requests.")):new Promise(e=>{this.waitingResolvers.push(e)})}stopListening(){return n(this,null,function*(){this.reading=!1,this.flushQueues();for(let e=0;e<10;e++)yield this.writeLine("#DUMMY");yield this.writeLine("#DUMMY@")})}onDisconnect(){setTimeout(()=>this.autoConnect(),1e3)}static \u0275fac=function(t){return new(t||a)(v(w),v(g))};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};var y=class a extends u{mode="usb";samplesToTest=1e3;delayOnLatencyMeasurement=0;encoder=new TextEncoder;decoder=new TextDecoder;device;interfaceNumber=0;endpointOut=0;endpointIn=0;configurationValue=1;requestDevice(){return n(this,null,function*(){try{this.device=yield navigator.usb.requestDevice({filters:[{vendorId:12346}]})}catch(e){console.error("USB device request failed:",e)}yield this.checkAvailableDevice()})}checkAvailableDevice(){return n(this,null,function*(){let e=yield navigator.usb.getDevices();this.hasAvailableDevice.set(e.length>0)})}connect(){return n(this,null,function*(){if(!this.device)return;this.device.opened||(yield this.device.open()),this.device.configuration===null&&(yield this.device.selectConfiguration(this.configurationValue));let e=this.findCDCInterfaceAndEndpoints();e&&(this.interfaceNumber=e.interfaceNumber,this.endpointIn=e.endpointIn,this.endpointOut=e.endpointOut,yield this.device.claimInterface(this.interfaceNumber),this.isConnected.set(!0),navigator.usb.addEventListener("disconnect",t=>{this.device&&t.device===this.device&&(this.consoleService.addConsoleLine("Device disconnected."),this.isConnected.set(!1),this.stopListening(),this.onDisconnect())}),yield this.startListening(),yield this.writeLine("CMD=@BRAND;"))})}autoConnect(){return n(this,null,function*(){let e=yield navigator.usb.getDevices();return e.length===0?!1:(this.device=e[0],yield this.connect(),!0)})}disconnect(){return n(this,null,function*(){if(this.device){yield this.writeLine("CMD=@CLA;");try{this.device.opened&&(yield this.device.releaseInterface(this.interfaceNumber),yield this.device.close())}catch(e){console.warn("Error during disconnect:",e)}finally{this.device=void 0,this.isConnected.set(!1)}yield this.checkAvailableDevice()}})}writeLine(e){return n(this,null,function*(){if(!this.device)return;let t=e.replace(/;/g,`;
`),r=this.encoder.encode(t.endsWith(`
`)?t:t+`
`);yield this.device.transferOut(this.endpointOut,r),this.consoleService.addConsoleLine(e)})}writeLineToSource(e){return n(this,null,function*(){if(!this.device)return;let t=this.encoder.encode(e+`
`);yield this.device.transferOut(this.endpointOut,t)})}readLineFromSource(e=0){return n(this,null,function*(){if(!this.device)return"";let t=yield this.device.transferIn(this.endpointIn,64),i=this.decoder.decode(t.data?.buffer||new ArrayBuffer(0)).trim();return i||(e<3?this.readLineFromSource(e++):"")})}getProperties(){return this.device?[{name:"productName",value:this.device.productName},{name:"productId",value:"0x"+this.device.productId.toString(16).padStart(4,"0")},{name:"vendorId",value:"0x"+this.device.vendorId.toString(16).padStart(4,"0")},{name:"manufacturerName",value:this.device.manufacturerName},{name:"serialNumber",value:this.device.serialNumber},{name:"interfaceNumber",value:this.interfaceNumber},{name:"endpointIn",value:this.endpointIn},{name:"endpointOut",value:this.endpointOut}]:[]}readChunk(){return n(this,null,function*(){if(!this.device)return["",!1];let e=yield this.device.transferIn(this.endpointIn,64);return[this.decoder.decode(e.data?.buffer||new ArrayBuffer(0)),!1]})}findCDCInterfaceAndEndpoints(){if(!this.device?.configuration?.interfaces)return null;for(let e of this.device.configuration.interfaces)for(let t of e.alternates){let{interfaceClass:r,endpoints:i}=t;if(r===10||r===255){let d=i.find(m=>m.direction==="in")?.endpointNumber,h=i.find(m=>m.direction==="out")?.endpointNumber;if(d!==void 0&&h!==void 0)return{interfaceNumber:e.interfaceNumber,endpointIn:d,endpointOut:h}}}return null}static \u0275fac=(()=>{let e;return function(r){return(e||(e=b(a)))(r||a)}})();static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};var L=class a extends u{mode="serial";samplesToTest=500;delayOnLatencyMeasurement=3;baudRate=115200;port=null;reader=null;writer=null;readableStreamClosed=null;writableStreamClosed=null;requestDevice(){return n(this,null,function*(){try{this.port=yield navigator.serial.requestPort()}catch(e){console.error("USB device request failed:",e)}yield this.checkAvailableDevice()})}checkAvailableDevice(){return n(this,null,function*(){let e=yield navigator.serial.getPorts();this.hasAvailableDevice.set(e.length>0)})}connect(){return n(this,null,function*(){if(!this.port)return;yield this.port.open({baudRate:this.baudRate});let e=new TextDecoder,t=new TransformStream({transform(i,d){d.enqueue(e.decode(i,{stream:!0}))}});this.readableStreamClosed=this.port.readable.pipeTo(t.writable),this.reader=t.readable.getReader();let r=new TextEncoderStream;this.writableStreamClosed=r.readable.pipeTo(this.port.writable)??null,this.writer=r.writable.getWriter(),this.readableStreamClosed?.catch(i=>{this.consoleService.addConsoleLine("Device disconnected."),this.isConnected.set(!1),this.stopListening(),this.onDisconnect()}),this.isConnected.set(!0),yield this.startListening(),yield this.writeLine("CMD=@BRAND;")})}autoConnect(){return n(this,null,function*(){let e=yield navigator.serial.getPorts();return e.length===0?!1:(this.port=e[0],yield this.connect(),!0)})}disconnect(){return n(this,null,function*(){try{if(this.reading=!1,this.reader){try{yield this.reader.cancel()}catch(e){console.warn("Reader cancel failed:",e)}this.reader.releaseLock(),this.reader=null}if(this.writer){try{yield this.writer.close()}catch(e){console.warn("Writer close failed:",e)}this.writer.releaseLock(),this.writer=null}this.port&&this.port.readable?.locked===!1&&this.port.writable?.locked===!1&&(yield this.port.close()),this.port=null,this.isConnected.set(!1)}catch(e){console.error("Failed to disconnect:",e)}})}writeLine(e){return n(this,null,function*(){if(!this.writer)return;let t=e.trim().replace(/;\s*/g,`;
`),r=t.endsWith(`
`)?t:t+`
`;yield this.writer.write(r),this.consoleService.addConsoleLine(e)})}writeLineToSource(e){return n(this,null,function*(){this.writer&&(yield this.writer.write(e+`
`))})}readLineFromSource(e=0){return n(this,null,function*(){if(!this.reader)return"";let{value:t,done:r}=yield this.reader.read();if(r||t===void 0)return"";let i=t.trim();return i||(e<3?this.readLineFromSource(e++):"")})}getProperties(){let e=this.port?.getInfo();return e?[{name:"Vendor ID",value:e.usbVendorId?.toString(16).padStart(4,"0")??"Unknown"},{name:"Product ID",value:e.usbProductId?.toString(16).padStart(4,"0")??"Unknown"}]:[]}readChunk(){return n(this,null,function*(){if(!this.reader)return["",!1];let{value:e,done:t}=yield this.reader.read();return[e,t]})}static \u0275fac=(()=>{let e;return function(r){return(e||(e=b(a)))(r||a)}})();static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};var M=class a{constructor(e){this.supabaseService=e;let t=localStorage.getItem("cteno-hardware-connection-mode"),r=t==="usb"||t==="serial"?t:"serial";E(()=>{this.hardwareIP.set(this.core.hardwareIP())})}connectionMode=s("serial");hardwareIP=s(localStorage.getItem("cteno-hardware-connection-ip"));usbService=C(y);serialService=C(L);core=this.usbService;setMode(e){return n(this,null,function*(){localStorage.setItem("cteno-hardware-connection-mode",e),this.connectionMode.set(e),this.core=e==="usb"?this.usbService:this.serialService,yield this.core.checkAvailableDevice()})}writeLine(e){return n(this,null,function*(){yield this.core.writeLine(e),this.supabaseService.userTier()==="Developer"&&console.log(">>>",e)})}readLine(){return n(this,null,function*(){return yield this.core.readLine()})}static \u0275fac=function(t){return new(t||a)(v(g))};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};export{w as a,M as b};
